#!/bin/bash

source cs_dirs

sudo localectl set-locale LANG=en_CA.UTF-8

cd $HOME_DIR
git pull && git submodule init && git submodule update && git submodule status

echo HOME set at $HOME_DIR
echo 'Updating apt-get'
sudo apt-get -y update
sudo apt-get install curl

echo Configuring node repo
curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -

echo 'Installing packages'
sudo apt-get -y install nodejs npm ffmpeg nginx emacs tmux mc locate libpam0g-dev libssl-dev mc dnsmasq

echo 'Get node scratch deps'
cd $HOME_DIR/scratch-gui
npm install

echo Installing web scraper globally
sudo npm install website-scraper -g

cd $HOME_DIR

echo 'Removing ntp -> interfers with dhclient'
sudo apt-get -y remove ntp

echo 'Stopping nginx'
sudo service nginx stop
sudo service dnsmasq stop
sudo unlink /etc/nginx/sites-enabled/default

echo Copying nginx config over to /etc/nginx/
sudo cp -a $HOME_DIR/nginx/* /etc/nginx/

echo 'Copy dns configs'
sudo cp -a $HOME_DIR/dns/cs.conf /etc/dnsmasq.d/
sudo cp -a $HOME_DIR/dns/rc.local /etc/
sudo cp -a $HOME_DIR/dns/dhclient.conf /etc/dhcp/
sudo cp -a $HOME_DIR/dns/interfaces /etc/network/
sudo rm -f /etc/rc5.d/S02dnsmasq
sudo rm -f /etc/rc2.d/S02dnsmasq
sudo rm -f /etc/rc4.d/S02dnsmasq
sudo rm -f /etc/rc3.d/S02dnsmasq

echo Removing default_type in nginx.conf
sudo grep -v default_type /etc/nginx/nginx.conf > /tmp/nginx.conf
sudo mv /tmp/nginx.conf /etc/nginx/nginx.conf
sudo unlink /etc/nginx/sites-enabled/cs
sudo ln -s /etc/nginx/sites-available/cs /etc/nginx/sites-enabled/cs

echo Creating directories
sudo ln -s $WWW /var/www
mkdir -p $WWW
mkdir -p $WWW_DOWNLOAD
mkdir -p $SCRATCH

echo 'Starting nginx'
sudo service nginx start

echo Configure stage is done. 
